{% extends "base.html" %}

{% set active_page = "Database" %}


{% block head %}
    <script src="{{ url_for('static', filename='node_modules/react/umd/react.development.js') }}"></script>
    <script src="{{ url_for('static', filename='node_modules/react-dom/umd/react-dom.development.js') }}"></script>
    <script src="{{ url_for('static', filename='node_modules/graphiql/graphiql.min.js') }}"></script>
    <script src="{{ url_for('static', filename='node_modules/@graphiql/plugin-explorer/dist/index.umd.js') }}"></script>
    <script src="{{ url_for('static', filename='node_modules/codemirror/lib/codemirror.js') }}"></script>
{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='node_modules/graphiql/graphiql.min.css') }}"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='node_modules/@graphiql/plugin-explorer/dist/style.css') }}"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='node_modules/codemirror/lib/codemirror.css') }}"/>
    <style>
        .CodeMirror:not(.cm-s-graphiql) {
          /* from Bootstrap .form-control */
          font-size: 1rem;
          font-weight: 400;
          line-height: 1.5;
          color: #495057;
          border: 1px solid #ced4da;
          border-radius: .25rem;
        }
        .CodeMirror-focused:not(.cm-s-graphiql) {
          /* from Bootstrap .form-control-focused */
          border-color: #66afe9;
          outline: 0;
          box-shadow: 0 0 0 .2rem rgba(0, 123, 255, .25);
          transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
        }
    </style>
{% endblock %}


{% block body %}

<div class="row justify-content-center" style="font-size: 0.9rem;">

    <div class="col-sm-12 mt-4">
        <h3>Database Search with GraphQL</h3>

        <form class="form-horizontal" action="" method="post" enctype="multipart/form-data">
            {% for table in tables %}
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="tableRadio" id="tableRadio{{ loop.index }}"
                           value="{{ table }}" {% if loop.index == 1 %}checked{% endif %}>
                    <label class="form-check-label" for="tableRadio{{ loop.index }}">
                        {{ table }}
                    </label>
                    {# help button to open help modal #}
                    <button type="button" class="btn btn-primary btn-sm" data-toggle="modal"
                            data-target="#{{ table }}Modal" style="border-radius: 50%; padding: 2px 6px;">
                        <i class="fas fa-question"></i>
                    </button>
                </div>
            {% endfor %}

            <label class="control-label" for="textarea">GraphQL query $where filter:</label><br />
            <div>
                <textarea name="textarea" rows="5" style="resize: vertical; position: relative; z-index: 1;"
                          class="form-control" id="textarea">
                    {%- if last_query %}{{ last_query }}{% endif -%}
                </textarea>
            </div>
            <button type="submit" value=submit class="btn btn-primary" id="input_submit">
                <i class="fas fa-search"></i> Search
            </button>
        </form>

        {% for table, query in tables.items() %}
            {# help modal #}
            <div class="modal fade" id="{{ table }}Modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">{{ table }} query</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            Start a search in FACT's database on the table {{ table }}. Internally this works with the following GraphQL query:
                            <pre>
                                <code id="{{ table }}-example">{{ query }}</code>
                            </pre>
                            The only part that you need to provide is the $where part, which is used to filter the results. You can copy the query to GraphiQL and play around with it.
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="copyToClipboard('{{ table }}-example')">Copy to Clipboard</button>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}

        <h5 class="mt-3">GraphiQL query editor:</h5>
        <div id="graphiql">Loading...</div>

        <script>
          const root = ReactDOM.createRoot(document.getElementById('graphiql'));
          const fetcher = GraphiQL.createFetcher({
            url: 'http://localhost:{{ port }}/v1/graphql',
            headers: { 'x-hasura-admin-secret': '{{ secret }}' },
          });
          const explorerPlugin = GraphiQLPluginExplorer.explorerPlugin();
          root.render(
            React.createElement(GraphiQL, {
              fetcher,
              defaultEditorToolsVisibility: true,
              plugins: [explorerPlugin],
            }),
          );
          const cm = CodeMirror.fromTextArea(document.getElementById('textarea'), {
		    lineNumbers: true,
          });
          function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).innerText.trim();
            navigator.clipboard.writeText(text).then(() => {}, function(err) {
              console.error('Async: Could not copy to clipboard: ', err);
            });
          }
          function submitForm(e) {

          }
        </script>

        <a href="https://hasura.io/docs/latest/queries/postgres/filters/index/">
            Documentation on writing Hasura postgres GraphQL queries
        </a>
    </div>
</div>

{% endblock %}
