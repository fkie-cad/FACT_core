# Docker image for FACT_core
The docker image provides an installation of all fact components (db, frontend,
backend). Currently, you have to build it yourself, but we plan to provide a
prebuilt image via Dockerhub. For instructions see [Advanced usage](#advanced-usage).

Because FACT uses docker itself, the docker socket from the host will be
passed to the container. Please make sure that your user is a member of the
`docker` group.

## Most simple usage
If you just want to run FACT and not worry about anything we've got your back.
Be aware that all state of FACT is only in the container so if you pull a new
FACT version everything (most importantly your database) will be lost.

> Note that the image is currently not uploaded so you have to
[build](#advanced-usage) it yourself

Simply run
```bash
# Pull docker containers needed on the host
# This is just needed the first time you use FACT
docker run \
	--rm \
	-it \
	--group-add $(getent group docker | cut -d: -f3) \
	-v /var/run/docker.sock:/var/run/docker.sock \
	fkiecad/fact pull-containers

# The docker daemon will write some things in there
mkdir /tmp/fact-docker-tmp && chgrp docker /tmp/fact-docker-tmp

# Start fact
docker run \
	-it \
	--name fact \
	--group-add $(getent group docker | cut -d: -f3) \
	-v /var/run/docker.sock:/var/run/docker.sock \
	-v /tmp/fact-docker-tmp:/tmp/fact-docker-tmp \
	-p 5000:5000 \
	fkiecad/fact start
```

## Advanced usage
For more advanced usage we provide a Makefile to cover most usecases.
If your usecase is not supported feel free to open a PR or hack it up privately.

To build the image run `make build`.
All avaiable commands are: `build`, `pull`, `run`, `start`, `stop`, `remove` and
`help`.
A short help for these commands can be shown with `make help`.

The Makefile can be configured with some [environment variables](#environment-variables)

If you use `FACT_CONFIG_DIR` and change anything related to the mongodb
database run `touch $FACT_WT_MONGODB_PATH/REINITIALIZE_DB`.
This will tell the container to (re)initialize the database.
If you use the container the first time you also have to do this.

### Environment variables
The Makefile uses the following environment variables.

`VERSION`: The version to be tagged when running `make build`

`IMAGE_NAME`: The name to be tagged when running `make build`

`CONTAINER_NAME`: The name of the container

`DOCKER_HOST`: Path to the docker socket. Default is `/var/run/docker.sock`

`FACT_CONFIG_DIR`: Path to the directory containing all config files for FACT.
Default is `../src/config`

`FACT_DOCKER_DIR`: The path on the host that the container should instruct
docker to output files generated by running other docker images (e.g. the
fact-extractor). This currently must match `temp_dir_path` in `main.cfg`.
Default is `/tmp`

`FACT_FW_DATA_PATH`: Path to the fact\_fw\_data directory on the host. Default
is `/media/data/fact\_fw\_data/`

`FACT_FW_DATA_GID`: Group of the `FACT_FW_DATA_PATH` directory. The group must
have rwx permissions. Default is `id -g`

`FACT_WT_MONGODB_PATH`: Path to the fact_wt_mongodb directory on the host.
Default is `/media/data/fact\_wt\_mongodb/`

`FACT_WT_MONGODB_GID`: Group of the `FACT_WT_MONGODB_PATH` directory. The group
must have rwx permissions. Default is `id -g`


# Distributed setup
If you want to have a distributed setup you have to build the three images.
For this you can simply adapt the Dockerfile to install the respective
components and change the entrypoint.
Then follow the instructions in [INSTALL.md](../INSTALL.md) for a distributed
setup.
You should also have a look at the Makefile to see what arguments docker should
be started with.

# Workarounds used
As FACT uses docker heavily, we pass the docker socket to the container.

One use of docker is the unpacker. Docker is started with something along the
lines of
`docker run -v PATH_ON_DOCKER_HOST:HARDCODED_PATH_USED_IN_THE_CONTAINER unpacker`.

This means that when FACT runs inside an container it must have access to
`PATH_ON_DOCKER_HOST`.
Currently `PATH_ON_DOCKER_HOST` is always a subdirectory of `temp_dir_path` but
created dynamically (similar to `mktemp`). This means that we can't know in
advance what directories on the host will be needed in the container. To work
around this we simply mount `temp_dir_path` in the container.
